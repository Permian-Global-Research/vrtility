<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Harmonized Landsat Sentinel-2 • vrtility</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Harmonized Landsat Sentinel-2">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vrtility</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/HLS.html">Harmonized Landsat Sentinel-2</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Permian-Global-Research/vrtility/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Harmonized Landsat Sentinel-2</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Permian-Global-Research/vrtility/blob/main/vignettes/HLS.Rmd" class="external-link"><code>vignettes/HLS.Rmd</code></a></small>
      <div class="d-none name"><code>HLS.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The Harmonized Landsat Sentinel-2 (HLS) project is fantastic dataset
offering global, harmonized surface reflectance data from Landsat 8 and
Sentinel-2 satellites. The combined measurement enables global
observations of the land every 2–3 days at 30-meter (m) spatial
resolution. The data has a high quality cloud/shadow bitmask layer,
enabling the creation of excellent cloud-free composites. Further
information on HLS can be found at the following links:</p>
<ul>
<li><p><a href="https://hls.gsfc.nasa.gov/" class="external-link uri">https://hls.gsfc.nasa.gov/</a></p></li>
<li><p><a href="https://lpdaac.usgs.gov/products/hlsl30v002/" class="external-link uri">https://lpdaac.usgs.gov/products/hlsl30v002/</a></p></li>
<li><p><a href="https://github.com/nasa/HLS-Data-Resources?tab=readme-ov-file" class="external-link uri">https://github.com/nasa/HLS-Data-Resources?tab=readme-ov-file</a></p></li>
</ul>
<p>Combining the Harmonized landsat and sentinel collections does
require some additional work because the two collections have different
numbers of bands with different names.</p>
<p>This Vignette outlines a workflow to combine the two collections into
a single median composite image that maintains all available bands.</p>
<p>You will need to have an Earthdata account to access the HLS data.
You can create an account at <a href="https://urs.earthdata.nasa.gov/users/new" class="external-link uri">https://urs.earthdata.nasa.gov/users/new</a>.</p>
</div>
<div class="section level2">
<h2 id="workflow-setup">Workflow setup<a class="anchor" aria-label="anchor" href="#workflow-setup"></a>
</h2>
<p>First we load the <code>vrtility</code> package and set up our
multiprocessing daemons using the <code>mirai</code> package. Using
mirai daemons allows for the automated speed up of several of the
vrtility processing steps.</p>
<p>Next we define our area of interest, we do this using the
<code>gdalraster</code> package but you can as easily simply provide a
numeric vector (length 4) with lon/lat coordinates ordered by xmin,
ymin, xmax, ymax.</p>
<p>When working with any raster data it is often more convenient to use
a projected coordinate system. The <code>bbox_to_projected</code>
function provides a convenient way to reproject a bounding box, either
with a specific spatial reference system (SRS) or using a default SRS
appropriate for the area of interest. The default SRS is an equal area
projection centered around the centroid of the bounding box.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://permian-global-research.github.io/vrtility/">vrtility</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mirai/man/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">gdalraster</span><span class="fu">::</span><span class="fu"><a href="https://usdaforestservice.github.io/gdalraster/reference/bbox_from_wkt.html" class="external-link">bbox_from_wkt</a></span><span class="op">(</span></span>
<span>  wkt <span class="op">=</span> <span class="st">"POINT (144.3 -7.6)"</span>,</span>
<span>  extend_x <span class="op">=</span> <span class="fl">0.17</span>,</span>
<span>  extend_y <span class="op">=</span> <span class="fl">0.125</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">te</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_helpers.html">bbox_to_projected</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span><span class="va">trs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">te</span>, <span class="st">"wkt"</span><span class="op">)</span></span></code></pre></div>
<p>Now we need to find the data. we need to query both the HLS Landsat
and Sentinel-2 collections. The <code>hls_stac_query</code> function
provides a convenient way to do this. First we will query the HLS
Landsat collection. Here we set a maximum cloud cover of 35% and a date
range of 2023-01-01 to 2023-12-31. we can see that of a total of 70
images, only 6 had less than 35% cloud cover.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hlssl_stac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stac_utilities.html">hls_stac_query</a></span><span class="op">(</span></span>
<span>  bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2023-01-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2023-12-31"</span>,</span>
<span>  max_cloud_cover <span class="op">=</span> <span class="fl">35</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"HLSL30_2.0"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">hlssl_stac</span><span class="op">)</span></span>
<span><span class="co">#&gt; ###Items</span></span>
<span><span class="co">#&gt; - matched feature(s): 70</span></span>
<span><span class="co">#&gt; - features (6 item(s) / 64 not fetched):</span></span>
<span><span class="co">#&gt;   - HLS.L30.T55MBM.2023017T003226.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.L30.T54MZS.2023017T003226.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.L30.T55MBM.2023065T003210.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.L30.T54MZS.2023065T003210.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.L30.T55MBM.2023337T003219.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.L30.T54MZS.2023337T003219.v2.0</span></span>
<span><span class="co">#&gt; - assets: B01, B02, B03, B04, B05, B06, B07, B09, B10, B11, Fmask</span></span>
<span><span class="co">#&gt; - item's fields: </span></span>
<span><span class="co">#&gt; assets, bbox, collection, geometry, id, links, properties, stac_extensions, stac_version, type</span></span></code></pre></div>
<p>And now we will query the HLS Sentinel-2 collection using the same
parameters. Again we can see that &lt; 10% of images have less than 35%
cloud cover.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hlsss_stac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stac_utilities.html">hls_stac_query</a></span><span class="op">(</span></span>
<span>  bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2023-01-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2023-12-31"</span>,</span>
<span>  max_cloud_cover <span class="op">=</span> <span class="fl">35</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"HLSS30_2.0"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">hlsss_stac</span><span class="op">)</span></span>
<span><span class="co">#&gt; ###Items</span></span>
<span><span class="co">#&gt; - matched feature(s): 98</span></span>
<span><span class="co">#&gt; - features (8 item(s) / 90 not fetched):</span></span>
<span><span class="co">#&gt;   - HLS.S30.T54MZS.2023029T004701.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T55MBM.2023074T004709.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T55MBM.2023079T004701.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T55MBM.2023109T004701.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T54MZS.2023109T004701.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T55MBM.2023319T004701.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T55MBM.2023364T004709.v2.0</span></span>
<span><span class="co">#&gt;   - HLS.S30.T54MZS.2023364T004709.v2.0</span></span>
<span><span class="co">#&gt; - assets: </span></span>
<span><span class="co">#&gt; B01, B02, B03, B04, B05, B06, B07, B08, B09, B10, B11, B12, B8A, Fmask</span></span>
<span><span class="co">#&gt; - item's fields: </span></span>
<span><span class="co">#&gt; assets, bbox, collection, geometry, id, links, properties, stac_extensions, stac_version, type</span></span></code></pre></div>
<p>In order to download the data we need to set up our Earthdata
credentials. The simplest way to do this is with the <a href="https://boettiger-lab.github.io/earthdatalogin/" class="external-link">earthdatalogin</a>
package. But, because we are using asynchronous mirai daemons, we need
to set the credentials for all daemons.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mirai/man/everywhere.html" class="external-link">everywhere</a></span><span class="op">(</span><span class="fu">earthdatalogin</span><span class="fu">::</span><span class="fu"><a href="https://boettiger-lab.github.io/earthdatalogin/reference/edl_netrc.html" class="external-link">edl_netrc</a></span><span class="op">(</span></span>
<span>  username <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"EARTHDATA_USER"</span><span class="op">)</span>,</span>
<span>  password <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"EARTHDATA_PASSWORD"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can begin forming the VRT pipeline. Here we “collect” all of
the assets from the STAC collections. This is essentially just a list of
virtual rasters. This can take a little time due to VRT validation -
however, GDAL caching makes re-accessing these remote files faster, for
the subsequent parts of the workflow.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hls_sl_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_collect.html">vrt_collect</a></span><span class="op">(</span><span class="va">hlssl_stac</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">hls_sl_col</span><span class="op">)</span></span>
<span><span class="co">#&gt; → &lt;VRT Collection&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  VRT SRS: </span></span>
<span><span class="co">#&gt; PROJCS["WGS 84 / UTM zone 55N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",147],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32655"]]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  PROJCS["WGS 84 / UTM zone 54N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",141],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32654"]]</span></span>
<span><span class="co">#&gt; Bounding Box: NA</span></span>
<span><span class="co">#&gt; Pixel res: 30, 30</span></span>
<span><span class="co">#&gt; Start Date: 2023-01-17 00:32:26 UTC</span></span>
<span><span class="co">#&gt; End Date: 2023-12-03 00:32:19 UTC</span></span>
<span><span class="co">#&gt; Number of Items: 6</span></span>
<span><span class="co">#&gt; Assets: B01, B02, B03, B04, B05, B06, B07, B09, B10, B11, Fmask</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">hls_ss_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_collect.html">vrt_collect</a></span><span class="op">(</span><span class="va">hlsss_stac</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">hls_ss_col</span><span class="op">)</span></span>
<span><span class="co">#&gt; → &lt;VRT Collection&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  VRT SRS: </span></span>
<span><span class="co">#&gt; PROJCS["WGS 84 / UTM zone 54N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",141],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32654"]]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  PROJCS["WGS 84 / UTM zone 55N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",147],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32655"]]</span></span>
<span><span class="co">#&gt; Bounding Box: NA</span></span>
<span><span class="co">#&gt; Pixel res: 30, 30</span></span>
<span><span class="co">#&gt; Start Date: 2023-01-29 00:49:07 UTC</span></span>
<span><span class="co">#&gt; End Date: 2023-12-30 00:49:10 UTC</span></span>
<span><span class="co">#&gt; Number of Items: 8</span></span>
<span><span class="co">#&gt; Assets: B01, B02, B03, B04, B05, B06, B07, B08, B8A, B09, B10, B11, B12, Fmask</span></span></code></pre></div>
<p>The print method for vrt_collection objects gives us a high level
overview of the imagery we will download. Our collections contain images
with two different SRS. We can also see that the number of bands differs
across the two collections.</p>
<p>Now we set the mask function required for the HLS data. The “Fmask”
band is a true bitmask (unlike other datasets which may use ineger
masks). Therefore we must use the <code>build_bitmask</code> function to
set the mask and can specify the bits that we wish to set as nodata
across all bands.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hls_sl_col_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_set_maskfun.html">vrt_set_maskfun</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_sl_col</span>,</span>
<span>  mask_band <span class="op">=</span> <span class="st">"Fmask"</span>,</span>
<span>  mask_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  build_mask_pixfun <span class="op">=</span> <span class="fu"><a href="../reference/vrt_set_maskfun.html">build_bitmask</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  drop_mask_band <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">hls_ss_col_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_set_maskfun.html">vrt_set_maskfun</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_ss_col</span>,</span>
<span>  mask_band <span class="op">=</span> <span class="st">"Fmask"</span>,</span>
<span>  mask_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  build_mask_pixfun <span class="op">=</span> <span class="fu"><a href="../reference/vrt_set_maskfun.html">build_bitmask</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  drop_mask_band <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># let's check out a vrt and inspect the mask function that we used.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">hls_sl_col_mask</span>, maskfun <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; → &lt;VRT Collection&gt;</span></span>
<span><span class="co">#&gt; Mask Function:</span></span>
<span><span class="co">#&gt; import numpy as np</span></span>
<span><span class="co">#&gt; def build_bitmask(in_ar, out_ar, xoff, yoff, xsize, ysize, raster_xsize,</span></span>
<span><span class="co">#&gt;                   raster_ysize, buf_radius, gt, **kwargs):</span></span>
<span><span class="co">#&gt;     # Convert comma-separated bit positions to integers</span></span>
<span><span class="co">#&gt;     bit_positions = [int(x) for x in kwargs['mask_values'].decode().split(',')]</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt;     # Initialize mask array with zeros</span></span>
<span><span class="co">#&gt;     mask = np.zeros_like(in_ar[0], dtype=bool)</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt;     # Combine masks for each bit position using OR</span></span>
<span><span class="co">#&gt;     for bit in bit_positions:</span></span>
<span><span class="co">#&gt;         mask |= np.bitwise_and(in_ar[0], np.left_shift(1, bit)) &gt; 0</span></span>
<span><span class="co">#&gt;     </span></span>
<span><span class="co">#&gt;     # Set output: 255 for valid pixels (mask True), 0 for invalid</span></span>
<span><span class="co">#&gt;     out_ar[:] = np.where(mask, 0, 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  VRT SRS: </span></span>
<span><span class="co">#&gt; PROJCS["WGS 84 / UTM zone 55N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",147],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32655"]]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  PROJCS["WGS 84 / UTM zone 54N",GEOGCS["WGS 84",DATUM["WGS_1984",SPHEROID["WGS 84",6378137,298.257223563,AUTHORITY["EPSG","7030"]],AUTHORITY["EPSG","6326"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4326"]],PROJECTION["Transverse_Mercator"],PARAMETER["latitude_of_origin",0],PARAMETER["central_meridian",141],PARAMETER["scale_factor",0.9996],PARAMETER["false_easting",500000],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["Easting",EAST],AXIS["Northing",NORTH],AUTHORITY["EPSG","32654"]]</span></span>
<span><span class="co">#&gt; Bounding Box: NA</span></span>
<span><span class="co">#&gt; Pixel res: 30, 30</span></span>
<span><span class="co">#&gt; Start Date: 2023-01-17 00:32:26 UTC</span></span>
<span><span class="co">#&gt; End Date: 2023-12-03 00:32:19 UTC</span></span>
<span><span class="co">#&gt; Number of Items: 6</span></span>
<span><span class="co">#&gt; Assets: B01, B02, B03, B04, B05, B06, B07, B09, B10, B11</span></span></code></pre></div>
<p>Now we need to align these data so that we can composite all the
imagery in one go. We can do this by simply adding nodata bands where
required. In the case of the HLS Landsat collection, we also need to
move the position of the cirrus band to match that of the HLS Sentinel-2
collection.</p>
<p>Similarly, with HLS Sentinel-2, we need to add the thermal bands that
are absent, but critically, note that we need to specify the scale value
for these bands. If this isn’t provided then the scale from the first
band is used (which in this case is 0.0001) or if there is no scale, it
is ignored. Automating this is tricky but if you miss an appropriate
scale, you will see warnings when you then use
<code>vrt_stack</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hls_ls_align</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_set_band_names.html">vrt_set_band_names</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_sl_col_mask</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"G"</span>, <span class="st">"R"</span>, <span class="st">"N2"</span>, <span class="st">"S1"</span>, <span class="st">"S2"</span>, <span class="st">"C"</span>, <span class="st">"T1"</span>, <span class="st">"T2"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">4</span>, description <span class="op">=</span> <span class="st">"RE1"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">5</span>, description <span class="op">=</span> <span class="st">"RE2"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">6</span>, description <span class="op">=</span> <span class="st">"RE3"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">7</span>, description <span class="op">=</span> <span class="st">"N"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">9</span>, description <span class="op">=</span> <span class="st">"WV"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_move_band.html">vrt_move_band</a></span><span class="op">(</span>band_idx <span class="op">=</span> <span class="fl">13</span>, after <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">hls_ss_align</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_set_band_names.html">vrt_set_band_names</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_ss_col_mask</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"G"</span>, <span class="st">"R"</span>, <span class="st">"RE1"</span>, <span class="st">"RE2"</span>, <span class="st">"RE3"</span>, <span class="st">"N"</span>, <span class="st">"N2"</span>, <span class="st">"WV"</span>, <span class="st">"C"</span>, <span class="st">"S1"</span>, <span class="st">"S2"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">13</span>, description <span class="op">=</span> <span class="st">"T1"</span>, scale_value <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_add_empty_band.html">vrt_add_empty_band</a></span><span class="op">(</span>after <span class="op">=</span> <span class="fl">14</span>, description <span class="op">=</span> <span class="st">"T2"</span>, scale_value <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<p>Now we can combine the two collections into a single collection using
the <code>c</code> method. This is a simple concatenation of the two
collections.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hls_merge_coll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_ls_align</span>,</span>
<span>  <span class="va">hls_ss_align</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we need to warp all vrt_blocks in the collection to the same
spatial reference system, extent and pixel size. This is particularly
important in this case because of the multiple SRS in the collection.
Also to make use of the fastest <code>vrt_compute</code> engine, we need
to ensure that all blocks are in the same SRS with equal dimensions.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hls_warp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_warp.html">vrt_warp</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_merge_coll</span>,</span>
<span>  t_srs <span class="op">=</span> <span class="va">trs</span>,</span>
<span>  te <span class="op">=</span> <span class="va">te</span>,</span>
<span>  tr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span>,</span>
<span>  resampling <span class="op">=</span> <span class="st">"bilinear"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we want to “reduce” the imagery collection to a single composite
image. The typical approach would be to use the band-level median which
we can achieve easily by first using the following:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">band_level_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_stack.html">vrt_stack</a></span><span class="op">(</span><span class="va">hls_warp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_pixelfun.html">vrt_set_pixelfun</a></span><span class="op">(</span>pixfun <span class="op">=</span> <span class="fu"><a href="../reference/vrt_set_pixelfun.html">median_numpy</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_compute.html">vrt_compute</a></span><span class="op">(</span><span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">file_temp</a></span><span class="op">(</span>ext <span class="op">=</span> <span class="st">".tif"</span><span class="op">)</span>,</span>
<span>    engine <span class="op">=</span> <span class="st">"gdalraster"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>However, we can also create composites using more advanced
statistical methods that can improve on the filtering of outliers,
increase scene consistency and ensure that spectral properties are
preserved. Several functions are provided in the <code>vrtility</code>
package to do this but the user can also provide their own if desired.
Here we will use the <code>geomedian</code> function which calculates
the geometric (aka spatial median). This synthetic statistic ensures
consistency across bands. note that where some bands dont exist, the
median is used in place of the geometric median.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hls_composite</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/multiband_reduce.html">multiband_reduce</a></span><span class="op">(</span><span class="va">hls_warp</span>, reduce_fun <span class="op">=</span> <span class="fu"><a href="../reference/multiband_reduce.html">geomedian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s take a look at the composite - first RGB and then a false
colour composite.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_raster.html">plot_raster_src</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_composite</span>,</span>
<span>  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_raster.html">plot_raster_src</a></span><span class="op">(</span></span>
<span>  <span class="va">hls_composite</span>,</span>
<span>  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">12</span>, <span class="fl">13</span><span class="op">)</span>,</span>
<span>  minmax_pct_cut <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">28</span>, <span class="fl">97</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/hls-plot-1.png" width="50%"><img src="figure/hls-plot-2.png" width="50%"></p>
<p>And all the other bands too:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">walk</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/plot_raster.html">plot_raster_src</a></span><span class="op">(</span></span>
<span>    <span class="va">hls_composite</span>,</span>
<span>    bands <span class="op">=</span> <span class="va">i</span>,</span>
<span>    pal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">hcl.colors</a></span><span class="op">(</span><span class="fl">256</span>, <span class="st">"Rocket"</span><span class="op">)</span>,</span>
<span>    legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    axes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/hls-plot-bands-1.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hugh Graham.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
