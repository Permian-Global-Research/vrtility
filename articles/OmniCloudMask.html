<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>OmniCloudMask • vrtility</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="OmniCloudMask">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vrtility</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cdse-sentinel-2.html">Copernicus Data Space Ecosystem Sentinel-2</a></li>
    <li><a class="dropdown-item" href="../articles/Digital-Earth-Africa-GeoMAD.html">Digital Earth Africa GeoMAD</a></li>
    <li><a class="dropdown-item" href="../articles/EOPF.html">EOPF Sentinel-2 Level-2A</a></li>
    <li><a class="dropdown-item" href="../articles/HLS.html">Harmonized Landsat Sentinel-2</a></li>
    <li><a class="dropdown-item" href="../articles/ndvi-timeseries.html">Creating NDVI Time Series from HLS Data</a></li>
    <li><a class="dropdown-item" href="../articles/OmniCloudMask.html">OmniCloudMask</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Permian-Global-Research/vrtility/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>OmniCloudMask</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Permian-Global-Research/vrtility/blob/main/vignettes/OmniCloudMask.Rmd" class="external-link"><code>vignettes/OmniCloudMask.Rmd</code></a></small>
      <div class="d-none name"><code>OmniCloudMask.Rmd</code></div>
    </div>

    
    
<p>One of the most powerful features the VRT format is the ability to
run any python code on a raster dataset, on the fly, using python pixel
functions. The range of possible for this is massive and vrtility only
scratches the surface of what is possible here.</p>
<p>In this vignette, we demonstrate how to use the OmniCloudMask model
to generate a cloud mask for Sentinel-2 imagery.</p>
<p><a href="https://github.com/DPIRD-DMA/OmniCloudMask" class="external-link">OmniCloudMask</a> is a
Python library for state-of-the-art cloud and cloud shadow segmentation
in high to moderate resolution satellite imagery. By providing only the
red, green, and near-infrared bands, the model produces a cloud mask
using a pre-trained convolutional neural network (CNN).</p>
<p>The <code>vrtility</code> package makes it easy to integrate
OmniCloudMask cloud masking directly into a VRT file. This approach
yields significantly better results than standard masking products
included with Sentinel-2 L2A or Landsat imagery.</p>
<p>In this example, we focus on the Zurich area and test the limits of
both the OmniCloudMask and the standard Sentinel-2 scene classsification
(SCL) band by including imagery with up to 80% cloud cover.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://permian-global-research.github.io/vrtility/">vrtility</a></span><span class="op">)</span></span>
<span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">gdalraster</span><span class="fu">::</span><span class="fu"><a href="https://usdaforestservice.github.io/gdalraster/reference/bbox_from_wkt.html" class="external-link">bbox_from_wkt</a></span><span class="op">(</span></span>
<span>  wkt <span class="op">=</span> <span class="st">"POINT (8.51 47.38)"</span>,</span>
<span>  extend_x <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  extend_y <span class="op">=</span> <span class="fl">0.06</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">te</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_helpers.html">bbox_to_projected</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span><span class="va">trs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">te</span>, <span class="st">"wkt"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">s2_stac</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stac_utilities.html">sentinel2_stac_query</a></span><span class="op">(</span></span>
<span>  bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2024-04-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2024-05-30"</span>,</span>
<span>  max_cloud_cover <span class="op">=</span> <span class="fl">80</span>,</span>
<span>  assets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B02"</span>, <span class="st">"B03"</span>, <span class="st">"B04"</span>, <span class="st">"B08"</span>, <span class="st">"SCL"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># number of items:</span></span>
<span><span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/items_functions.html" class="external-link">items_length</a></span><span class="op">(</span><span class="va">s2_stac</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 9</span></span></code></pre></div>
<p>Next, let’s download all of the rasters locally. This step is not
always necessary but, in this case, we are plotting intermediate data
and we . We use <code>with</code> to isolate the use of mirai
daemons.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zurich_vrt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_collect.html">vrt_collect</a></span><span class="op">(</span><span class="va">s2_stac</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_warp.html">vrt_warp</a></span><span class="op">(</span></span>
<span>    t_srs <span class="op">=</span> <span class="va">trs</span>,</span>
<span>    te <span class="op">=</span> <span class="va">te</span>,</span>
<span>    tr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_compute.html">vrt_compute</a></span><span class="op">(</span></span>
<span>    recollect <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now we are ready to create a cloud mask using the
<code>vrt_create_mask</code> function. This function requires two main
arguments: <code>inbands</code> and <code>maskfun</code>.</p>
<ul>
<li><p><code>inbands</code> should be a named numeric vector, where the
names correspond to the required input bands for the masking function.
For OmniCloudMask, these are <code>"red"</code>, <code>"green"</code>,
and <code>"nir"</code>.</p></li>
<li><p><code>maskfun</code> specifies the masking function to use.
Currently, the only available option is
<code><a href="../reference/vrt_create_mask.html">create_omnicloudmask()</a></code>, but <code>vrt_create_mask</code> is
designed to support additional masking functions in the future.</p></li>
</ul>
<p>This approach allows you to flexibly apply cloud masking to your VRT
collections using state-of-the-art models.</p>
<div class="section level2">
<h2 id="todo-this-needs-rewriting-masks-are-now-materialised-immediately-">TODO: this needs rewriting masks are now materialised
immediately.<a class="anchor" aria-label="anchor" href="#todo-this-needs-rewriting-masks-are-now-materialised-immediately-"></a>
</h2>
<p><code>vrt_create_mask</code> composes a new vrt file, which is then
immediately materialised. This is at odds with other materialisation in
vrtility which will normally only occur when <code><a href="../reference/vrt_compute.html">vrt_compute()</a></code>
is called. The reason for this is to ensure that expensive cloud masking
operations are only performed once.</p>
<p>Note that we use <code>recollect = TRUE</code> to return a new
<code>vrt_collection</code> object because we plan to do some further
processing.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zurich_vrt_mask</span> <span class="op">&lt;-</span> <span class="va">zurich_vrt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_create_mask.html">vrt_create_mask</a></span><span class="op">(</span></span>
<span>    inbands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>red <span class="op">=</span> <span class="fl">3</span>, green <span class="op">=</span> <span class="fl">2</span>, nir <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>    maskfun <span class="op">=</span> <span class="fu"><a href="../reference/vrt_create_mask.html">create_omnicloudmask</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Now, let’s take a look at the OmniCloudMask and the Sentinel-2 SCL
bands, alongside the RGB image. We can clearly see that the
OmniCloudMask is identifying a greater area of clouds and shadows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">walk2</a></span><span class="op">(</span></span>
<span>  .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">5</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"RGB"</span>, <span class="st">"SCL"</span>, <span class="st">"OmniCloudMask"</span><span class="op">)</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="va">zurich_vrt_mask</span>,</span>
<span>    item <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    <span class="va">.x</span>,</span>
<span>    main <span class="op">=</span> <span class="va">.y</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/plot-mask-1.png"><img src="figure/plot-mask-2.png"><img src="figure/plot-mask-3.png"></p>
<p>Let’s examine the impact of masking on the actual image areas. We’ll
apply both masks and visually compare the results to assess the
performance of OmniCloudMask versus the Sentinel-2 SCL band.</p>
<p>When using <code><a href="../reference/vrt_set_maskfun.html">vrt_set_maskfun()</a></code>, you can specify which mask
values to treat as masked (i.e., set to NA). For the OmniCloudMask band,
the possible values are:</p>
<ul>
<li><p>0: clear</p></li>
<li><p>1: thick cloud</p></li>
<li><p>2: thin cloud</p></li>
<li><p>3: cloud shadow</p></li>
</ul>
<p>In this example, we mask all non-clear classes (values 1, 2, and
3).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scl_rgb</span> <span class="op">&lt;-</span> <span class="va">zurich_vrt_mask</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_maskfun.html">vrt_set_maskfun</a></span><span class="op">(</span></span>
<span>    mask_band <span class="op">=</span> <span class="st">"SCL"</span>,</span>
<span>    mask_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">8</span>, <span class="fl">9</span>, <span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ocm_rgb</span> <span class="op">&lt;-</span> <span class="va">zurich_vrt_mask</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_maskfun.html">vrt_set_maskfun</a></span><span class="op">(</span></span>
<span>    mask_band <span class="op">=</span> <span class="st">"omnicloudmask"</span>,</span>
<span>    mask_values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">walk2</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">scl_rgb</span>, <span class="va">ocm_rgb</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SCL RGB"</span>, <span class="st">"OmniCloudMask RGB"</span><span class="op">)</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="va">.x</span>,</span>
<span>    item <span class="op">=</span> <span class="fl">6</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    main <span class="op">=</span> <span class="va">.y</span>,</span>
<span>    na_col <span class="op">=</span> <span class="st">"#eb4310"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/apply-mask-1.png"><img src="figure/apply-mask-2.png"></p>
<p>The OmniCloudMask provides a more accurate and comprehensive
identification of clouds and shadows compared to the Sentinel-2 SCL
band. It also reduces false positives that are present in the SCL mask,
resulting in cleaner cloud detection.</p>
<p>Next, we will compute the median of the RGB bands in the vrt
collection for both the SCL-masked and OmniCloudMask-masked images, and
plot the results to visually compare their effectiveness.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scl_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_stack.html">vrt_stack</a></span><span class="op">(</span><span class="va">scl_rgb</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_py_pixelfun.html">vrt_set_py_pixelfun</a></span><span class="op">(</span>pixfun <span class="op">=</span> <span class="fu"><a href="../reference/vrt_set_py_pixelfun.html">mean_numpy</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_compute.html">vrt_compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ocm_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_stack.html">vrt_stack</a></span><span class="op">(</span><span class="va">ocm_rgb</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_py_pixelfun.html">vrt_set_py_pixelfun</a></span><span class="op">(</span>pixfun <span class="op">=</span> <span class="fu"><a href="../reference/vrt_set_py_pixelfun.html">mean_numpy</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_compute.html">vrt_compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">walk2</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">scl_median</span>, <span class="va">ocm_median</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"SCL RGB median"</span>, <span class="st">"OmniCloudMask RGB median"</span><span class="op">)</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="../reference/plot_raster.html">plot_raster_src</a></span><span class="op">(</span></span>
<span>    <span class="va">.x</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    main <span class="op">=</span> <span class="va">.y</span>,</span>
<span>    rgb_trans <span class="op">=</span> <span class="st">"gamma"</span>,</span>
<span>    axes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/compute-median-1.png"><img src="figure/compute-median-2.png"></p>
<p>Comparing the two median images, the difference is striking. The
OmniCloudMask-masked composite is much clearer, while the SCL-masked
image appears “milky” due to residual cloud artefacts. Although the SCL
composite could be improved by excluding scenes with higher cloud cover,
this example highlights the significant advantage of advanced cloud
masking. Additionally, further improvements can be achieved by applying
multi-dimensional reduction techniques such as those provided by
<code><a href="../reference/multiband_reduce.html">multiband_reduce()</a></code>.</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hugh Graham.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
