<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Copernicus Data Space Ecosystem Sentinel-2 • vrtility</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Copernicus Data Space Ecosystem Sentinel-2">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vrtility</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.01</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cdse-sentinel-2.html">Copernicus Data Space Ecosystem Sentinel-2</a></li>
    <li><a class="dropdown-item" href="../articles/Digital-Earth-Africa-GeoMAD.html">Digital Earth Africa GeoMAD</a></li>
    <li><a class="dropdown-item" href="../articles/EOPF.html">EOPF Sentinel-2 Level-2A</a></li>
    <li><a class="dropdown-item" href="../articles/HLS.html">Harmonized Landsat Sentinel-2</a></li>
    <li><a class="dropdown-item" href="../articles/OmniCloudMask.html">OmniCloudMask</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/Permian-Global-Research/vrtility/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Copernicus Data Space Ecosystem Sentinel-2</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Permian-Global-Research/vrtility/blob/main/vignettes/cdse-sentinel-2.Rmd" class="external-link"><code>vignettes/cdse-sentinel-2.Rmd</code></a></small>
      <div class="d-none name"><code>cdse-sentinel-2.Rmd</code></div>
    </div>

    
    
<p>The Copernicus Data Space Ecosystem (CDSE) provides access to a large
range of European Space Agency (ESA) and Copernicus data. They also
provide a STAC API for querying and accessing the data. However, there
are some unique aspects to working with the CDSE via gdal - firstly that
authentication is a bit unique and secondly (and most critically), the
Sentinel-2 data is stored in the Jpeg2000 format, rather than the more
common Cloud Optimised GeoTIFF (COG) format. This has a couple of
disadvantages, the main one being that, as the files aren’t cloud
optimised, we often have to download more than we need to, there is also
no embedded metadata describing values such as nodata, scale and
offset.</p>
<p>But we can still make good use of these data so let’s get to it.
Firstly here are some handy links:</p>
<p>CDSE STAC catalog:</p>
<p><a href="https://browser.stac.dataspace.copernicus.eu/?_language=en&amp;.language=en" class="external-link uri">https://browser.stac.dataspace.copernicus.eu/?_language=en&amp;.language=en</a></p>
<p>CDSE STAC API documentation:</p>
<p><a href="https://documentation.dataspace.copernicus.eu/APIs/STAC.html" class="external-link uri">https://documentation.dataspace.copernicus.eu/APIs/STAC.html</a></p>
<p>CDSE API quota:</p>
<p><a href="https://documentation.dataspace.copernicus.eu/Quotas.html" class="external-link uri">https://documentation.dataspace.copernicus.eu/Quotas.html</a></p>
<div class="section level2">
<h2 id="authentication-">Authentication.<a class="anchor" aria-label="anchor" href="#authentication-"></a>
</h2>
<p>Get the official authentication documentation <a href="https://documentation.dataspace.copernicus.eu/APIs/S3.html" class="external-link">here</a>.</p>
<p>You will need a CDSE account to access the data. Get yourself one
from <a href="https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/auth?client_id=cdse-public&amp;response_type=code&amp;scope=openid&amp;redirect_uri=https%3A//dataspace.copernicus.eu/account/confirmed/1" class="external-link">here</a>.</p>
<p>Once, you’re registered, navigate to the <a href="https://eodata-s3keysmanager.dataspace.copernicus.eu/" class="external-link">S3
credentials page</a> and create an “access key” and a “secret access
key”. Then Save these keys in your <code>.Renviron</code> file as
<code>CDSE_ACCESS_KEY</code> and <code>CDSE_SECRET_KEY</code>
respectively.</p>
</div>
<div class="section level2">
<h2 id="set-up-the-environment">Set up the environment<a class="anchor" aria-label="anchor" href="#set-up-the-environment"></a>
</h2>
<p>first we need to load vrtility and then set up parallel processing.
You must not set more than 4 daemons, as this is the limit for
concurrent requests to the CDSE API.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://permian-global-research.github.io/vrtility/">vrtility</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># only use 2 daemons!</span></span>
<span><span class="fu">mirai</span><span class="fu">::</span><span class="fu"><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="query-the-stac-api">Query the STAC API<a class="anchor" aria-label="anchor" href="#query-the-stac-api"></a>
</h2>
<p>We can now query the STAC API for the Sentinel-2 data. Here we are
looking at the level-2A data which is orthorectified
bottom-of-atmosphere reflectance.</p>
<p>We define our bounding bounding box (located in Assam, India) using
{gdalraster} for convenience and also create a copy in a local
projection system - we’ll use this later to warp the data to a common
projection.</p>
<p>We’ll query the data for the month of June 2025, select the bands we
want to download (here we’re grabbing, blue, green, red, near-infrared
and the scene classification layer), and finally filter the results to
only include images with a maximum cloud cover of 30%.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu">gdalraster</span><span class="fu">::</span><span class="fu"><a href="https://usdaforestservice.github.io/gdalraster/reference/bbox_from_wkt.html" class="external-link">bbox_from_wkt</a></span><span class="op">(</span></span>
<span>  wkt <span class="op">=</span> <span class="st">"POINT (95.415 27.78)"</span>,</span>
<span>  extend_x <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  extend_y <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bbx_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial_helpers.html">bbox_to_projected</a></span><span class="op">(</span><span class="va">bbox</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># run the STAC query</span></span>
<span><span class="va">s2copdse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stac_utilities.html">stac_query</a></span><span class="op">(</span></span>
<span>  bbox <span class="op">=</span> <span class="va">bbox</span>,</span>
<span>  stac_source <span class="op">=</span> <span class="st">"https://stac.dataspace.copernicus.eu/v1"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"sentinel-2-l2a"</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2025-06-01"</span>,</span>
<span>  end_date <span class="op">=</span> <span class="st">"2025-06-30"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">rstac</span><span class="fu">::</span><span class="fu"><a href="https://brazil-data-cube.github.io/rstac/reference/assets_functions.html" class="external-link">assets_select</a></span><span class="op">(</span></span>
<span>    asset_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B02_10m"</span>, <span class="st">"B03_10m"</span>, <span class="st">"B04_10m"</span>, <span class="st">"B08_10m"</span>, <span class="st">"SCL_20m"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/stac_utilities.html">stac_cloud_filter</a></span><span class="op">(</span>max_cloud_cover <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="download-and-create-a-cloud-free-median-composite">Download and create a “cloud-free” median composite<a class="anchor" aria-label="anchor" href="#download-and-create-a-cloud-free-median-composite"></a>
</h2>
<p>Now we have our STAC query, we can create a
<code>vrt_collection</code> object which encapsulates all the image
assets as VRT datasets. Note that we need to set some GDAL environment
variables. For more details on the significance of these variables see
the GDAL <a href="https://gdal.org/en/stable/user/virtual_file_systems.html#vsis3-aws-s3-files" class="external-link">vsis3
documentation</a>. We then need to add important metadata to the VRT
files including the nodata, scale and offset values.</p>
<p>Next we apply a mask to the data using the scene classification layer
(SCL) to remove cloudy pixels. this isn’t a perfect mask but it is a
good start (more on that to come in the future).</p>
<p>Then we create a collection of virtually warped VRTs, which are
aligned to a common spatial reference system (SRS) and resolution. This
is done using the <code>vrt_warp</code> function and we specify the
target SRS, the extent of the data and the target resolution.</p>
<p>The next step requires us to stack the collection (essentially
combining each band from across epochs), we can then set a pixel
function to calculate the median value for each pixel across the
stack.</p>
<p>Finally, we compute the median composite using the
<code>vrt_compute</code> function, which writes the output to a file. We
use the <code>gdalraster</code> engine to process the data in parallel
across bands and image tiles.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download the data and process</span></span>
<span><span class="va">s2_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vrt_collect.html">vrt_collect</a></span><span class="op">(</span><span class="va">s2copdse</span>,</span>
<span>  <span class="fu"><a href="../reference/gdal_options.html">gdal_config_opts</a></span><span class="op">(</span></span>
<span>    AWS_VIRTUAL_HOSTING <span class="op">=</span> <span class="st">"FALSE"</span>,</span>
<span>    AWS_ACCESS_KEY_ID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"CDSE_ACCESS_KEY"</span><span class="op">)</span>,</span>
<span>    AWS_SECRET_ACCESS_KEY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"CDSE_SECRET_KEY"</span><span class="op">)</span>,</span>
<span>    AWS_S3_ENDPOINT <span class="op">=</span> <span class="st">"eodata.dataspace.copernicus.eu"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_move_band.html">vrt_move_band</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_nodata.html">vrt_set_nodata</a></span><span class="op">(</span><span class="fl">0</span>, band_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_scale.html">vrt_set_scale</a></span><span class="op">(</span>scale_value <span class="op">=</span> <span class="fl">0.0001</span>, offset_value <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, band_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_maskfun.html">vrt_set_maskfun</a></span><span class="op">(</span></span>
<span>    mask_band <span class="op">=</span> <span class="st">"SCL_20m"</span>,</span>
<span>    mask_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">8</span>, <span class="fl">9</span>, <span class="fl">10</span>, <span class="fl">11</span><span class="op">)</span>,</span>
<span>    drop_mask_band <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_warp.html">vrt_warp</a></span><span class="op">(</span></span>
<span>    t_srs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">bbx_proj</span>, <span class="st">"wkt"</span><span class="op">)</span>,</span>
<span>    te <span class="op">=</span> <span class="va">bbx_proj</span>,</span>
<span>    tr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_stack.html">vrt_stack</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_set_py_pixelfun.html">vrt_set_py_pixelfun</a></span><span class="op">(</span><span class="fu"><a href="../reference/vrt_set_py_pixelfun.html">median_numpy</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/vrt_compute.html">vrt_compute</a></span><span class="op">(</span></span>
<span>    outfile <span class="op">=</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_temp.html" class="external-link">file_temp</a></span><span class="op">(</span>ext <span class="op">=</span> <span class="st">"tif"</span><span class="op">)</span>,</span>
<span>    engine <span class="op">=</span> <span class="st">"gdalraster"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualise-the-results">Visualise the results<a class="anchor" aria-label="anchor" href="#visualise-the-results"></a>
</h2>
<p>Finally, let’s plot the NIR band on its own and then the RGB
composite.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_raster.html">plot_raster_src</a></span><span class="op">(</span><span class="va">s2_median</span>, bands <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/s2-plots-1.png"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/plot_raster.html">plot_raster_src</a></span><span class="op">(</span><span class="va">s2_median</span>, bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/s2-plots-2.png"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hugh Graham.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
